{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "functions": [
    {
        "namespace": "helpers",
            "members": {
                "uniqueName": {
                    "parameters": [
                        {"name": "resourceName", "type": "string"},
                        {"name": "preffix" , "type": "string"},
                        {"name": "location", "type" : "string"}],
                "output": {
                    "type": "string",
                    "value": "[toLower(concat(parameters('resourceName'),'-',parameters('preffix'),'-',parameters('location')))]"}}}
    }],
    "parameters": {
        "preffix": {
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "databaseUsername":{
            "type": "string",
            "defaultValue": "mysqladmin"
        },
        "databasePassword": {
            "type": "securestring"
        }
    },
    "variables": {
        "plan_name":        "[helpers.uniqueName('plan',parameters('preffix'),parameters('location'))]",
        "plan_sku": {
                            "name": "S1",
                            "tier": "Standard",
                            "size": "S1",
                            "family": "S",
                            "capacity": 1},
        "webapp_name":      "[helpers.uniqueName('app',parameters('preffix'),parameters('location'))]",
        "dbServer_name":    "[helpers.uniqueName('db',parameters('preffix'),parameters('location'))]",
        "db_sku": {
                            "name": "GP_Gen5_4",
                            "tier": "GeneralPurpose",
                            "family": "Gen5",
                            "capacity": 4},
        "db_properties": {
                             "administratorLogin": "[parameters('databaseUsername')]",
                            "administratorLoginPassword": "[parameters('databasePassword')]",
                            "storageProfile": {
                                "storageMB": 102400,
                                "backupRetentionDays": 7,
                                "geoRedundantBackup": "Disabled",
                                "storageAutogrow": "Enabled"
                            },
                            "version": "5.7",
                            "sslEnforcement": "Enabled",
                            "minimalTlsVersion": "TLSEnforcementDisabled",
                            "infrastructureEncryption": "Disabled",
                            "publicNetworkAccess": "Enabled"},
        "vnet_name":"[helpers.uniqueName('vnet',parameters('preffix'),parameters('location'))]"
    },
    "resources": [
        {
            "type": "Microsoft.DBforMySQL/servers",
            "apiVersion": "2017-12-01",
            "name": "[variables('dbServer_name')]",
            "location": "[parameters('location')]",
            "sku": "[variables('db_sku')]",
            "properties": "[variables('db_properties')]"
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2020-11-01",
            "name": "[variables('vnet_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.2.0.0/16"
                    ]
                },
                "subnets": [
                    {
                        "name": "snet-webapp",
                        "properties": {
                            "addressPrefix": "10.2.1.0/24",
                            "serviceEndpoints": [
                                {
                                    "service": "Microsoft.Sql",
                                    "locations": [
                                        "[parameters('location')]"
                                    ]
                                }
                            ],
                            "delegations": [
                                {
                                    "name": "delegation",
                                    "properties": {
                                        "serviceName": "Microsoft.Web/serverfarms"
                                    }
                                }
                            ],
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    }
                ],
                "virtualNetworkPeerings": [],
                "enableDdosProtection": false
            }
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2021-02-01",
            "name": "[variables('plan_name')]",
            "location": "[parameters('location')]",
            "sku": "[variables('plan_sku')]",
            "kind": "linux",
            "properties": {
                "perSiteScaling": false,
                "elasticScaleEnabled": false,
                "maximumElasticWorkerCount": 1,
                "isSpot": false,
                "reserved": true,
                "isXenon": false,
                "hyperV": false,
                "targetWorkerCount": 0,
                "targetWorkerSizeId": 0,
                "zoneRedundant": false
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2020-11-01",
            "name": "[concat(variables('vnet_name'), '/snet-mysql')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnet_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.2.0.0/24",
                "serviceEndpoints": [
                    {
                        "service": "Microsoft.Sql",
                        "locations": [
                            "[parameters('location')]"
                        ]
                    }
                ],
                "delegations": [],
                "privateEndpointNetworkPolicies": "Disabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Web/sites/config",
            "apiVersion": "2021-02-01",
            "name": "[concat(variables('webapp_name'), '/web')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webapp_name'))]"
            ],
            "properties": {
                "numberOfWorkers": 1,
                "linuxFxVersion": "JAVA|8-jre8",
                "publishingUsername": "$app-testmitok",
                "alwaysOn": true,
                "appCommandLine": "java -jar /home/site/wwwroot/eschool.jar",
                "managedPipelineMode": "Integrated",
                "virtualApplications": [
                    {
                        "virtualPath": "/",
                        "physicalPath": "site\\wwwroot",
                        "preloadEnabled": true
                    }
                ],
                "loadBalancing": "LeastRequests",
                "vnetName": "[variables('vnet_name')]",
                "vnetRouteAllEnabled": true
            }
        },
        {
            "type": "Microsoft.DBforMySQL/servers/virtualNetworkRules",
            "apiVersion": "2017-12-01",
            "name": "[concat(variables('dbServer_name'), '/webappAcceess')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/servers', variables('dbServer_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), 'snet-webapp')]"
            ],
            "properties": {
                "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), 'snet-webapp')]",
                "ignoreMissingVnetServiceEndpoint": false
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2021-02-01",
            "name": "[variables('webapp_name')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('plan_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), 'snet-webapp')]"
            ],
            "kind": "app,linux",
            "properties": {
                "enabled": true,
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('plan_name'))]",
                "reserved": true,
                "siteConfig": {
                    "numberOfWorkers": 1,
                    "linuxFxVersion": "JAVA|8-jre8",
                    "acrUseManagedIdentityCreds": false,
                    "alwaysOn": true,
                    "http20Enabled": false,
                    "functionAppScaleLimit": 0,
                    "minimumElasticInstanceCount": 1
                },
                "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), 'snet-webapp')]"
            }
        },
        {
            "type": "Microsoft.Web/sites/virtualNetworkConnections",
            "apiVersion": "2021-02-01",
            "name": "[concat(variables('webapp_name'), '/',variables('vnet_name'))]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webapp_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), 'snet-webapp')]"
            ],
            "properties": {
                "vnetResourceId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), 'snet-webapp')]",
                "isSwift": true
            }
        }
    ]
}
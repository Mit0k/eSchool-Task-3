# eSchool-Task-3

DevOps Internship 2022 (SoftServe IT Academy) <br />

# Task: <br />

## **Main**:

Write ARM template to deploy infrastructure for [eSchool Application](https://github.com/Mit0k/eSchool) <br />

## **Additional**:

### Template related:

- use ArmTTK for testing template **-> Passing 123/125 test cases**
- configure scaleout on 50% of CPU usage or 50 requests per minute
- configure notification on high CPU usage into Email/Slack

### Other:

- configure pipeline for deploying app (Azure DevOps)
- make app accessible by it's domain name.

## Simplified scheme:<br /> ![Untitled Diagram drawio (1)](https://user-images.githubusercontent.com/28260968/168128928-ad9b30fc-f26a-4c05-9358-5643ef314371.png)

## Usage:

### Manual:

- Clone repo
- Change default parameters in `templates\azuredeploy.parameters.json`: <br />
  - **Preferably to change:** <br />
    - `databaseUsername` 
    - `minInstances, maxInstances` - min/max instances that would be created on autoscale of WebApp 
    - `cpuThreshold `- if CPU percentage > `cpuThreshold` - you will get notification on Slack<br />
  - **On need can be changed:**<br />
    - `vnetAddressPrefixes, snetAddressPrefix, snetDBAddressPrefix `- adress prefixes for network config
  - _The rest of parameters is or autogenerated or will be passed through script_
- Run `templates\azuredeploy.json` with required parameters:
  - **Location** - in which region will be deployed project
  - **prefix** - will be used to name creation (e.g. test)
  - **slackURL** - you will need to add an [incoming webhook](https://slack.com/intl/en-au/help/articles/115005265063-Incoming-webhooks-for-Slack) to your Slack channel
  - **userObjectID** - User with this ID will have access to KeyVault. Can be skipped on manual usage. [How to find it](https://docs.microsoft.com/en-us/partner-center/find-ids-and-domain-names)

### Azure DevOps:

- Create a ARM [service connection](https://docs.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&tabs=yaml)
- Create new pipeline based on this repo
- Change default parameters as written above
- Select an existing YAML file: `azure-pipelines.yml`
- Change variables in `azure-pipelines.yml`:
  - **Location** - in which region will be deployed project
  - **prefix** - will be used to name creation (e.g. test)
  - **subscription** - name of your service connection
- Add [variable group](https://docs.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&tabs=classic) to pipeline with followed secret variables: `slackURL` and `userObjectID` <br />_Note: Preferably to use Azure KeyVault to [link secrets](https://docs.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&tabs=yaml#link-secrets-from-an-azure-key-vault) to variable group_

- Run

## Features:

- Easy to track deploying - each stage of script followed by debug messages. On errors script would try to get details.
- Highly configurable - I tried to follow best practices so there is low amount of parameters
- All resource names are meet by [name convention](https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-abbreviations)
- Generating and storing passwords in Azure KeyVault (without changing password on each run)
- Access Policy defined to grant `"List", "Get", "Set"` permissions to:
  - chosen _User_ (pass `user ObjectID`)
  - currently used _Application_ which started deploying - in our case DevOps account (by using `Get-AzContext` function from Azure CLI)
  - WebApp - to get app setting
- Modular structure - template divided to three parts (each module will be deployed to different Resource Group):
  - Common - VNet, Flexible MySQL server(using Private DNS zone), KeyVault
  - Metrics - serves to obtain metrics from WebApp (include Insights, Metrics, ActionGroup etc.) and Azure Function for sending notification
  - WebApp - the WebApp itself and its configurations
- WebApp autoscale on more than 50 requests per minute
- If WebApp consume more than 75% percent of CPU you will get notification to Slack like this: ![example](https://user-images.githubusercontent.com/28260968/169690676-f974af92-daba-477d-bdbc-26ff1e420635.png)

## Branches overview:

### main:

Modules is used in main template through template specs

### plain_version:

One template file for deploying whole infrastructure - no modular structure

### linked_via_github

Modules is used in main template through direct links to files on repo
